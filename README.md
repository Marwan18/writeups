# Subscription
As a challenge name is `Subscription` i thought about 'Persistence â€“ WMI Event Subscription'
So lets take  a look at WMI-Activity event logs

![alt text]( https://github.com/Marwan18/writeups/blob/main/Capture.PNG)

As expected found `WMI Event Subscription` and the event consumer is a powershell script after decoding it 
The subsequent section uses the Invoke-Expression cmdlet `invoke-expression` to execute the payload

```
 -jOIn ('20S26S28-20R24R73I48I65O4c}4cm69}44_5b}31R5d}2bO24I73R68R65}4cm4cO69O44S5b_31R33O5dm2b_27m78}27I29I20R28I20_28R20S5b-52O75I4eO74}49R6dm45S2eS69-4e_54S65_52O6fm50O73R65O72m56_49S63R45_73O2em6dm41-52R53S68m41O4cm5d}3am3aS50_74-72m74-6fI73S74R72-49I4eO67-62m53_54R72m28m5b_72}55}4eO54-49}6d-65R2eI49O4eI74-65-72_4f_50R73m65S72-76_49}43O45-53O2eR6dR61O72S73-68R61R6cI5dO3a-3aI53S45}63O75-72}45I73I74I52m69m4eR47-74-6fR62I53S74m72}28}24}28R27}37O36I34_39I32S64m31I31_31-36I37S34m33}66-30-34O32I33}34-31I33m62I31_36R30_35R30O61-35O33m34m35S4dO67I42O38S41_47}6f_41I63m41S42_75R41_45I59I41I64I51R42-76-41-44}45_41}55}67}42O48S41-45I59_41O65m67m42I33-41-44I6bS41_61_77O42R6aO41O46_45S41}54O77R42I58m41I45O6bR41m59O67S42S32_41O46-45m41-50I51R41-39_41}48I77S41}4dR67S42-69R41R44O55}41-4dI77S41O79-41-47R59O41S4d}77S42}69}41O47R51-41S59S77R41-30}41I47_45S41R59R77-41m77m41-47S4dm41S4d-41S41m32O41-44-4d-41_59I51_42}6c-41_44I6bI41m4eI51_41}7a_41R44_63O41m5am51S41m77m41S47I49S41I5aS51}42m6aO41}47O4dm41}4eS77}42R6bm41_44-55-41O4d_67S42-6a-41S44O59_41I4e_41m41I7a}41O44I4dI41S4eI41S42S68R41m44R67O41R59_51}41O77-41R47_55m41-5a}67O41}32}41I47m55_41O5a-67O42I6dO41R47_59m41S59_51I41R78S41O44}63}41R4eI41m41}79-41I44O55m41S4eI67_41_32_41-47R4dS41S4dR67I42I6a-41m44_67}41m5aO51-42O6dm41}44O55m41m59I51O41O32R41I47O49-41}59I51-41R31I41_47_49R41}4dS51R41-77}41-44I67}41-59}67}41O33-41S47m4d_41-5aR41R41m34-41}44S41_41}4em41}42S6d_41S44O6b-41m5aI67}41-77I41m47m49}41_5a}51O41I31_41S44I45O41O4fI51_41-77O41_44R6bS41O59}51_41m30R41S44S51_41O4d-77}42}69O41-47S4dO41m5a}67I41R77O41-44O6bI41}4fO41m41}35S41m47_59_41m4d-77}42}69m41-44S6bS41_4e-67m42m6cS41S44-4d-41I4d-67O41m33m41S47}4d}41-4fO41m41}34O41I44-67}41R5aI41I41-78_41m44S41-41}5a}51S41O32}41S47S59}41O4e}77O42m6b-41S44m55R41-4d}51O42}6bR41-44-45I41m5aO41O41m7am41_44}59I41I5a-51S41I33I41S44R6bI41_5aR41_41S34O41R44O55I41-4dm41}41_30S41}47_51_41m4eR51-41O31m41m44}41_41I4e}41S41R7a-41-47R59S41I59-51R41I35-41I47}49}41O4d}67}42}6cS41I44R63S41m4e}77}41O34I41S44}63m41m5a-67I41S30}41R44_63_41_4dR67}41_33-41R44S63m41O59I51m42R69O41_44R67O41-59O51}41I31-41m44-45_41}4dm51-42S6b}41I44m49O41_4eS51R41}30m41m44}49_41I4eR51_41_34_41_44m6bI41O4f}41}42_6dR41-44O63S41_4eI51m42O6dm41O44R45}41_4dR41O41O79I41-44O67m41R5aO67-42_6cS41S44R63m41R5aS41_42m6d-41O44S45S41}4dI51}41-35}41I44m63O41m4e-51O42R69R41m44_51_41m59O51O42}69_41-44m6b}41m4d_41I41R79m41I44O63I41-4d}51R42_6aS41m44R51O41}4d}67R41I34_41_47O49-41S5a_51S41R30R41O44_4d_41R59O77O41S77-41I47I51-41O4d-77-41I7a-41_44}63m41I59O77-42}6d-41I47_4d_41R5aO67R42-68R41S47S4dm41_4eS51m41S33_41R44-4d_41m59_67-41I35O41-47S4dS41S5a}51R41S32I41}47-45S41O4em77m42O6d_41}47_49-41S59S67O41m79R41_44-49-41m4fI51O41S7aS41R44_45S41-4eO51_41S31S41I47R55O41_59S67O41}35_41I44S49S41_4d_77}41R32I41-47m45O41R4dO51-41m30R41O47R55_41_4dI67O41R7a-41S44-63}41_5am51O41_32S41m44}6bI41m4dS41}41_79O41_47I55S41S4eR77m42-68S41_44R63m41m4dS67-41}30_41-44_4dR41}59O77I42O6aI41S44m67I41O5aO51-41}79}41m44m63R41}4dS51}42I6bR41m44R49R41-4dm77O41R79I41-44S49R41-59}51_41R31-41R44}4d_41I59}51m42-6bS41O47}51I41I4dm51S42}6am41I44}67I41}4d_41-42m69S41S44I63}41-5a}67m41_30m41S44}6bS41O4dR67I42}6d}41S44_49O41-59-67}41}7a}41}44I49I41-5aO51-41m32_41S44_4d_41O4f-41-41I31}41-47m49R41O4dR67S42-6bR41O47R59-41R4dR77O42S69O41I44}45}41O4d_77m41R34S41-44}45_41R4dm67-42}6cS41m44R4d_41S4d_67-41}7am41O44}45-41I59}51_41O35S41S44_4dI41O5am51}42_68I41m44m45R41_59I77-41O78m41I44m6b}41m59_51m42_69-41-44R49S41}4fO41S41I30m41S44I67S41R59-51S41_30_41O44_45-41S4eO77I41R30I41m47}45I41_4eI51-41_35-41m44}4dO41m4eO77m42I6aO41I44-67m41m4fS41S41-7a}41_44I4dR41S59m77O42O6bR41S47_55S41_4e-51R42m6dm41S47I59-41S59R77I42O6dS41_47I55O41O4dO77_42O6b_41O44O6bS41R5aR67S41R33O41_44-59I41O4eO51_42-69}41R44-41_41-4dS77S41O30_41m47}49I41_4eR51m42-6dS41S44I45O41I4eR77-41-7aR41}44I4dm41_5aS51I42-69m41-44S67O41}4e-67-41R31-41R47}4d}41}4dm77_42I68O41m47R4dS41R59-67R41m78S41O44-59R41S4dS41-41O34-41_44R51_41R4d-67I41R34O41R44m49R41m5aI41m42_6bm41S47}49m41}5a-67S41}32O41-44R63m41}4e-51R41I35m41R47-45-41m4eO41}41R30m41m47I51S41I4eI51R41m78m41}44S49m41-5a-51-41_31I41-41-3dI3dm27S7cm20O43R6fS6e}56}65I52}74-74O6fO2d_73R65O43R75-52O65S53S74m52m69_6em67I20-20_2dm6b_45-79-20I32m35}35_2cS31S31S33-2cO31m34R34I2cO31-33R2c_32R36_2cm31I32m36O2c_31m36-34O2cI33m38R2cI31I38_36-2cS33S32-2cR31}39}33m2cm31-34}34_2cI32}30m30R2cS39R39O2cR37O30-2cR33}37S29O29-29R20I29S20m29}20'-Split'O'-SPLIT'm'-SPlit'S'-SPliT'I'-SPlIt'}'-SpLit '-'-sPlIt '_' -SpliT'R'|fOreaCh{([cONvert]::tOiNt16(([STRING]$_) ,16) -as [char])} ) | inVOKE-eXpressIOn
 ```
 so after remove the invoke-expression and run the code it gives another stage 
 
```
 &( $sHeLLiD[1]+$sheLLiD[13]+'x') ( ( [RuNtImE.iNTeRoPserVIcEs.mARShAL]::PtrtostrINgbSTr([rUNTIme.INterOPservICES.marshal]::SEcurEstRiNGtobStr($('76492d1116743f0423413b16050a5345MgB8AGoAcABuAEYAdQBvADEAUgBHAEYAegB3ADkAawBjAFEATwBXAEkAYgB2AFEAPQA9AHwAMgBiADUAMwAyAGYAMwBiAGQAYwA0AGEAYwAwAGMAMAA2ADMAYQBlADkANQAzADcAZQAwAGIAZQBjAGMANwBkADUAMgBjADYANAAzADMANABhADgAYQAwAGUAZgA2AGUAZgBmAGYAYQAxADcANAAyADUANgA2AGMAMgBjADgAZQBmADUAYQA2AGIAYQA1AGIAMQAwADgAYgA3AGMAZAA4ADAANABmADkAZgAwAGIAZQA1ADEAOQAwADkAYQA0ADQAMwBiAGMAZgAwADkAOAA5AGYAMwBiADkANgBlADMAMgA3AGMAOAA4ADgAZAAxADAAZQA2AGYANwBkADUAMQBkADEAZAAzADYAZQA3ADkAZAA4ADUAMAA0AGQANQA1ADAANAAzAGYAYQA5AGIAMgBlADcANwA4ADcAZgA0ADcAMgA3ADcAYQBiADgAYQA1ADEAMQBkADIANQA0ADIANQA4ADkAOABmADcANQBmADEAMAAyADgAZgBlADcAZABmADEAMQA5ADcANQBiADQAYQBiADkAMAAyADcAMQBjADQAMgA4AGIAZQA0ADMAYwAwAGQAMwAzADcAYwBmAGMAZgBhAGMANQA3ADMAYgA5AGMAZQA2AGEANwBmAGIAYgAyADIAOQAzADEANQA1AGUAYgA5ADIAMwA2AGEAMQA0AGUAMgAzADcAZQA2ADkAMAAyAGUANwBhADcAMgA0ADMAYwBjADgAZQAyADcAMQBkADIAMwAyADIAYQA1ADMAYQBkAGQAMQBjADgAMABiADcAZgA0ADkAMgBmADIAYgAzADIAZQA2ADMAOAA1AGIAMgBkAGYAMwBiADEAMwA4ADEAMgBlADMAMgAzADEAYQA5ADMAZQBhADEAYwAxADkAYQBiADIAOAA0ADgAYQA0ADEANwA0AGEANQA5ADMANwBjADgAOAAzADMAYwBkAGUANQBmAGYAYwBmAGUAMwBkADkAZgA3ADYANQBiADAAMwA0AGIANQBmADEANwAzADMAZQBiADgANgA1AGMAMwBhAGMAYgAxADYAMAA4ADQAMgA4ADIAZABkAGIAZgA2ADcANQA5AGEANAA0AGQANQAxADIAZQA1AA=='| ConVeRtto-seCuReStRing  -kEy 255,113,144,13,26,126,164,38,186,32,193,144,200,99,70,37))) ) ) 
```
if you noticed it this part `( $sHeLLiD[1]+$sheLLiD[13]+'x')` is substituded with `iex` cmdlet then delete it again and run the code and finaly the flag popped up 

`CyCTF{WM1_P3r51573NC3_15_W0r7H_1NV35716471N6}`

